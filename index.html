<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="icon" type="image/x-icon" href="/images/favicon.ico">
<title>DumbGPT</title>
<style>
    /* ---------- RESET & VARIABLES ---------- */
    * { margin: 0; padding: 0; box-sizing: border-box; }
    :root {
        --sidebar-width: 260px;
        --bg-primary: #ffffff;
        --bg-secondary: #c3c3c3;
        --bg-sidebar: #ffffff;
        --text-primary: #000000;
        --text-secondary: #000000;
        --text-sidebar: #020202;
        --border-color: #e5e5e5;
        --hover-bg: #f0f0f0;
        --hover-sidebar: #c3c3c3;
        --accent: #ffffff;
    }
    body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        background: var(--bg-primary);
        color: #000;
        overflow: hidden;
        height: 100vh;
    }

    /* ---------- CONTAINERS ---------- */
    .app-container { display: flex; height: 100vh; }
    .sidebar { width: var(--sidebar-width); background: var(--bg-sidebar); display: flex; flex-direction: column; flex-shrink: 0; }
    .main-content { flex: 1; display: flex; flex-direction: column; background: var(--bg-primary); }

    /* ---------- SIDEBAR ---------- */
    .sidebar-header { padding: 12px; }
    .new-chat-btn { width: 100%; padding: 12px; background: transparent; border: 1px solid rgba(255,255,255,0.2); color: var(--text-sidebar); border-radius: 900px; cursor: pointer; display: flex; align-items: center; gap: 12px; font-size: 14px; transition: background 0.2s; }
    .new-chat-btn:hover { background: var(--hover-sidebar); }
    .chat-history { flex: 1; overflow-y: auto; padding: 8px; }
    .chat-item { padding: 10px 12px; margin: 2px 0; border-radius: 8px; cursor: pointer; color: var(--text-sidebar); font-size: 14px; display: flex; align-items: center; justify-content: space-between; transition: background 0.2s; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .chat-item:hover, .chat-item.active { background: var(--hover-sidebar); }
    .chat-item-text { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
    .chat-item-delete { opacity: 0; width: 20px; height: 20px; border-radius: 4px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; flex-shrink: 0; margin-left: 8px; }
    .chat-item:hover .chat-item-delete { opacity: 1; }
    .chat-item-delete:hover { background: rgba(0,0,0,0.1); }
    .sidebar-footer { padding: 12px; border-top: 1px solid rgba(255,255,255,0.1); }
    .user-menu { display: flex; align-items: center; gap: 12px; padding: 10px 12px; border-radius: 8px; cursor: pointer; transition: background 0.2s; position: relative; }
    .user-menu:hover { background: var(--hover-sidebar); }
    .user-avatar { width: 32px; height: 32px; border-radius: 30px; background: linear-gradient(135deg,#6e8efb,#a777e3); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 14px; overflow: hidden; }
    .user-avatar img { width: 100%; height: 100%; object-fit: cover; }
    .user-info { flex: 1; }
    .user-name { color: var(--text-sidebar); font-size: 14px; font-weight: 500; }
    .user-email { color: #000; font-size: 12px; }
    #profilePictureInput { display: none; }

    /* ---------- MAIN HEADER ---------- */
    .header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); display: flex; align-items: center; justify-content: space-between; height: 56px; }
    .model-selector-wrapper { position: relative; }
    .model-selector { display: flex; align-items: center; gap: 8px; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 14px; font-weight: 600; transition: background 0.2s; }
    .model-selector:hover { background: var(--hover-bg); }
    .model-dropdown { position: absolute; top: 100%; left: 0; margin-top: 4px; background: white; border: 1px solid var(--border-color); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); min-width: 280px; display: none; z-index: 100; }
    .model-dropdown.active { display: block; }
    .model-dropdown-header { padding: 12px 16px; border-bottom: 1px solid var(--border-color); font-weight: 600; font-size: 13px; color: var(--text-secondary); }
    .model-option { padding: 12px 16px; cursor: pointer; transition: background 0.2s; display: flex; flex-direction: column; gap: 4px; }
    .model-option:hover, .model-option.selected { background: var(--hover-bg); }
    .model-option-name { font-weight: 600; font-size: 14px; display: flex; align-items: center; gap: 8px; }
    .model-option-description { font-size: 12px; color: var(--text-secondary); }
    .model-checkmark { margin-left: auto; color: var(--accent); }

    /* ---------- CHAT CONTAINER ---------- */
    .chat-container { flex: 1; overflow-y: auto; display: flex; flex-direction: column; }
    .messages { flex: 1; max-width: 48rem; width: 100%; margin: 0 auto; padding: 24px; display: none; }
    .message { display: flex; gap: 16px; margin-bottom: 32px; }
    .message-avatar { width: 32px; height: 32px; border-radius: 4px; flex-shrink: 0; display: flex; align-items: center; justify-content: center; font-weight: 600; font-size: 14px; overflow: hidden; }
    .user-avatar-msg { background: linear-gradient(135deg,#6e8efb,#a777e3); color: white; }
    .assistant-avatar { background: var(--accent); color: white; }
    .message-content { flex: 1; padding-top: 6px; }
    .message-content p { margin-bottom: 16px; line-height: 1.6; }
    .message-content p:last-child { margin-bottom: 0; }
    .message-content code { 
        background-color: #ffffff;   /* clearer property name */
        padding: 2px 6px;
        border-radius: 20px;
        font-family: 'Courier New', monospace;
        font-size: 0.9em;
        border: 3px solid rgb(130, 130, 130); /* border now visible */
        display: inline-block; /* ensures proper padding and shape */
    }


    .empty-state { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; max-width: 48rem; margin: 0 auto; padding: 24px; }
    .empty-state h1 { font-size: 32px; font-weight: 600; margin-bottom: 48px; color: var(--text-primary); }
    .suggestions { display: grid; grid-template-columns: repeat(2,1fr); gap: 12px; width: 100%; max-width: 800px; }
    .suggestion-card { padding: 16px; border-radius: 12px; cursor: pointer; transition: all 0.2s; background: var(--bg-primary); }
    .suggestion-card:hover { background: var(--bg-secondary); }
    .suggestion-title { font-weight: 600; margin-bottom: 4px; font-size: 14px; }
    .suggestion-text { color: var(--text-secondary); font-size: 13px; }

    /* ---------- INPUT AREA ---------- */
    .input-area { padding: 24px; max-width: 48rem; width: 100%; margin: 0 auto; }
    .input-wrapper { position: relative; background: var(--bg-primary); border: 1px solid var(--border-color); border-radius: 24px; padding: 12px 52px 12px 16px; box-shadow: 0 0 0 1px rgba(0,0,0,0.05); transition: all 0.2s; }
    .input-wrapper:focus-within { border-color: var(--text-secondary); box-shadow: 0 0 0 2px rgba(0,0,0,0.05); }
    .input-field { width: 100%; border: none; outline: none; font-size: 15px; font-family: inherit; resize: none; max-height: 20px; overflow-y: auto; }
    .send-btn { position: absolute; right: 7px; bottom: 3px; width: 40px; height: 40px; border-radius: 30px; border: none; background: var(--text-primary); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: opacity 0.2s; }
    .send-btn:disabled { opacity: 0.3; cursor: not-allowed; }
    .send-btn:not(:disabled):hover { opacity: 0.8; }
    .disclaimer { text-align: center; color: var(--text-secondary); font-size: 12px; margin-top: 12px; }

    /* ---------- MODAL ---------- */
    .modal-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
    .modal-overlay.active { display: flex; }
    .modal { background: white; border-radius: 16px; padding: 24px; width: 90%; max-width: 500px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; }
    .modal-title { font-size: 20px; font-weight: 600; }
    .close-btn { width: 32px; height: 32px; border-radius: 30px; border: none; background: transparent; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: background 0.2s; }
    .close-btn:hover { background: var(--hover-bg); }
    .profile-picture-section { display: flex; flex-direction: column; align-items: center; margin-bottom: 24px; gap: 16px; }
    .profile-picture-large { width: 120px; height: 120px; border-radius: 60px; background: linear-gradient(135deg,#6e8efb,#a777e3); display: flex; align-items: center; justify-content: center; color: white; font-weight: 600; font-size: 48px; overflow: hidden; position: relative; }
    .profile-picture-large img { width: 100%; height: 100%; object-fit: cover; }
    .upload-btn-container { display: flex; gap: 8px; }
    .upload-btn, .remove-btn { padding: 8px 16px; border-radius: 8px; border: 1px solid var(--border-color); background: white; cursor: pointer; font-size: 14px; transition: all 0.2s; }
    .upload-btn:hover, .remove-btn:hover { background: var(--hover-bg); }
    .remove-btn { color: #dc2626; border-color: #dc2626; }
    .remove-btn:hover { background: #fef2f2; }
    .form-group { margin-bottom: 16px; }
    .form-label { display: block; margin-bottom: 8px; font-size: 14px; font-weight: 500; }
    .form-input { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; font-family: inherit; transition: all 0.2s; }
    .form-input:focus { outline: none; border-color: var(--text-primary); box-shadow: 0 0 0 3px rgba(0,0,0,0.05); }
    .modal-footer { display: flex; gap: 8px; justify-content: flex-end; margin-top: 24px; }
    .btn-cancel, .btn-save { padding: 10px 20px; border-radius: 8px; border: none; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .btn-cancel { background: transparent; border: 1px solid var(--border-color); }
    .btn-cancel:hover { background: var(--hover-bg); }
    .btn-save { background: var(--text-primary); color: white; }
    .btn-save:hover { opacity: 0.9; }

    /* ---------- SCROLLBARS ---------- */
    ::-webkit-scrollbar { width: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.2); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: rgba(0,0,0,0.3); }
    .sidebar ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); }
    .sidebar ::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.3); }
</style>
</head>
<body>
<div class="app-container">
    <!-- Sidebar -->
    <div class="sidebar">
        <img src="images/logo.png" alt="thelogo" width="100" height="100" style="padding:20px;">
        <div class="sidebar-header">
            <button class="new-chat-btn" onclick="createNewChat()">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <path d="M12 5v14M5 12h14"/>
                </svg> New chat
            </button>
        </div>
        <div class="chat-history" id="chatHistory">
            <div class="empty-chat-history">No chats yet</div>
        </div>
        <div class="sidebar-footer">
            <div class="user-menu" id="userMenuBtn">
                <div class="user-avatar" id="sidebarAvatar">
                    <span id="sidebarAvatarText">U</span>
                </div>
                <div class="user-info">
                    <div class="user-name" id="sidebarName">You</div>
                    <div class="user-email" id="sidebarEmail">fakeemail@closedai.com</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="header">
            <div class="model-selector-wrapper">
                <div class="model-selector" id="modelSelector">
                    <span id="currentModel">DumbGPT 4o</span>
                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M6 9l6 6 6-6"/>
                    </svg>
                </div>
                <div class="model-dropdown" id="modelDropdown">
                    <div class="model-dropdown-header">Select a model</div>
                    <div class="model-option selected" data-model="DumbGPT 4o" onclick="selectModel('DumbGPT 4o')">
                        <div class="model-option-name">DumbGPT 4o <span class="model-checkmark" id="check-dumbgpt-4o">✓</span></div>
                        <div class="model-option-description">Best overall performance, multimodal</div>
                    </div>
                    <div class="model-option" data-model="DumbGPT 4o mini" onclick="selectModel('DumbGPT 4o mini')">
                        <div class="model-option-name">DumbGPT 4o mini <span class="model-checkmark" id="check-dumbgpt-4o-mini" style="display:none;">✓</span></div>
                        <div class="model-option-description">Faster responses, great for simple tasks</div>
                    </div>
                </div>
            </div>
        </div>

        <div class="chat-container" id="chatContainer">
            <div class="empty-state" id="emptyState">
                <h1>How can I help you today?</h1>
                <div class="suggestions">
                    <div class="suggestion-card" onclick="sendSuggestion(this)">
                        <div class="suggestion-title">Generate code</div>
                        <div class="suggestion-text">Generate code from text prompts with AI</div>
                    </div>
                    <div class="suggestion-card" onclick="sendSuggestion(this)">
                        <div class="suggestion-title">Explain code</div>
                        <div class="suggestion-text">Paste code snippets and get explanations</div>
                    </div>
                    <div class="suggestion-card" onclick="sendSuggestion(this)">
                        <div class="suggestion-title">Plan an event</div>
                        <div class="suggestion-text">Get help organizing tasks and schedules</div>
                    </div>
                    <div class="suggestion-card" onclick="sendSuggestion(this)">
                        <div class="suggestion-title">Ask general questions</div>
                        <div class="suggestion-text">Get answers and insights on any topic</div>
                    </div>
                </div>
            </div>

            <div class="messages" id="messages"></div>

            <div class="input-area">
                <div class="input-wrapper">
                    <textarea id="userInput" class="input-field" placeholder="Send a message..."></textarea>
                    <button id="sendBtn" class="send-btn" disabled onclick="sendMessage()">
                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <path d="M22 2L11 13"/>
                            <path d="M22 2L15 22L11 13L2 9L22 2Z"/>
                        </svg>
                    </button>
                </div>
                <p class="disclaimer">DumbGPT works. I don't touch it</p>
            </div>
        </div>
    </div>
</div>

<!-- Profile Modal -->
<div class="modal-overlay" id="profileModal">
    <div class="modal">
        <div class="modal-header">
            <div class="modal-title">Edit Profile</div>
            <button class="close-btn" onclick="closeProfileModal()">×</button>
        </div>
        <div class="profile-picture-section">
            <div class="profile-picture-large" id="profilePictureLarge">Y</div>
        <div class="form-group">
            <label class="form-label" for="profileName">Name</label>
            <input type="text" id="profileName" class="form-input">
        </div>
        <div class="form-group">
            <label class="form-label" for="profileEmail">Email</label>
            <input type="email" id="profileEmail" class="form-input">
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeProfileModal()">Cancel</button>
            <button class="btn-save" onclick="saveProfile()">Save</button>
        </div>
    </div>
</div>

<!-- Marked.js for Markdown -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Highlight.js for code blocks -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/atom-one-dark.min.css">
<script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
<script>
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const messagesContainer = document.getElementById('messages');
const emptyState = document.getElementById('emptyState');
const chatContainer = document.getElementById('chatContainer');

let profileData = { name: 'You', email: 'fakeemail@closedai.com', picture: null };
let currentModelName = 'DumbGPT 4o';
let currentChatId = null;
let chats = {};

// ---- Model functions ----
function loadModel(){ const m=localStorage.getItem('dumbgpt_model'); if(m){ currentModelName=m; selectModel(currentModelName,false); } }
function saveModel(){ localStorage.setItem('dumbgpt_model',currentModelName); }
function selectModel(name,save=true){ currentModelName=name; document.getElementById('currentModel').textContent=name; document.querySelectorAll('.model-checkmark').forEach(m=>m.style.display='none'); const c=document.getElementById(`check-${name.replace(/\s+/g,'-').toLowerCase()}`); if(c)c.style.display='inline'; document.querySelectorAll('.model-option').forEach(o=>o.classList.remove('selected')); document.querySelector(`.model-option[data-model="${name}"]`)?.classList.add('selected'); if(save) saveModel(); closeModelDropdown(); }
function toggleModelDropdown(){ document.getElementById('modelDropdown').classList.toggle('active'); }
function closeModelDropdown(){ document.getElementById('modelDropdown').classList.remove('active'); }
document.getElementById('modelSelector').addEventListener('click',e=>{ e.stopPropagation(); toggleModelDropdown(); });
document.addEventListener('click',e=>{ const dd=document.getElementById('modelDropdown'); const sel=document.getElementById('modelSelector'); if(!dd.contains(e.target) && !sel.contains(e.target)) closeModelDropdown(); });

// ---- Profile functions ----
function loadProfile(){ const s=localStorage.getItem('dumbgpt_profile'); if(s){ profileData=JSON.parse(s); updateProfileUI(); } }
function saveProfileToStorage(){ localStorage.setItem('dumbgpt_profile',JSON.stringify(profileData)); }
function updateProfileUI(){ 
    document.getElementById('sidebarName').textContent=profileData.name;
    document.getElementById('sidebarEmail').textContent=profileData.email;
    const sa=document.getElementById('sidebarAvatar'); const sat=document.getElementById('sidebarAvatarText');
    if(profileData.picture){ sat.style.display='none'; sa.style.background='none'; sa.innerHTML=`<img src="${profileData.picture}" alt="Profile">`; }
    else{ sa.style.background='linear-gradient(135deg,#6e8efb,#a777e3)'; sa.innerHTML=`<span id="sidebarAvatarText">${profileData.name.charAt(0).toUpperCase()}</span>`; }
    document.getElementById('profileName').value=profileData.name;
    document.getElementById('profileEmail').value=profileData.email;
    const ma=document.getElementById('modalAvatar'); const mat=document.getElementById('modalAvatarText');
    if(profileData.picture){ mat.style.display='none'; ma.style.background='none'; ma.innerHTML=`<img src="${profileData.picture}" alt="Profile">`; document.getElementById('removePhotoBtn').style.display='block'; }
    else{ ma.style.background='linear-gradient(135deg,#6e8efb,#a777e3)'; ma.innerHTML=`<span id="modalAvatarText">${profileData.name.charAt(0).toUpperCase()}</span>`; document.getElementById('removePhotoBtn').style.display='none'; }
}
function openProfileModal(){ document.getElementById('profileModal').classList.add('active'); updateProfileUI(); }
function closeProfileModal(){ document.getElementById('profileModal').classList.remove('active'); }
function handleProfilePictureUpload(e){ const f=e.target.files[0]; if(f&&f.type.startsWith('image/')){ const r=new FileReader(); r.onload=ev=>{ profileData.picture=ev.target.result; updateProfileUI(); }; r.readAsDataURL(f); } }
function removeProfilePicture(){ profileData.picture=null; updateProfileUI(); }
function saveProfile(){ profileData.name=document.getElementById('profileName').value||'You'; profileData.email=document.getElementById('profileEmail').value||'fakeemail@closedai.com'; saveProfileToStorage(); updateProfileUI(); closeProfileModal(); }
document.getElementById('userMenuBtn').addEventListener('click',openProfileModal);
document.getElementById('profileModal').addEventListener('click',e=>{ if(e.target===this) closeProfileModal(); });

// ---- Chat functions ----
function generateChatId(){ return 'chat_'+Date.now()+'_'+Math.random().toString(36).substr(2,9); }
function loadChats(){ const s=localStorage.getItem('dumbgpt_chats'); if(s) chats=JSON.parse(s); renderChatHistory(); }
function saveChats(){ localStorage.setItem('dumbgpt_chats',JSON.stringify(chats)); }
function getChatTitle(msgs){ if(msgs.length>0 && msgs[0].role==='user'){ let t=msgs[0].content.substring(0,50); return msgs[0].content.length>50? t+'...':t; } return 'New Chat'; }
function createNewChat(){ const id=generateChatId(); chats[id]={id:id,messages:[],createdAt:Date.now(),updatedAt:Date.now()}; currentChatId=id; saveChats(); renderChatHistory(); clearMessages(); }
function loadChat(id){ currentChatId=id; clearMessages(); const c=chats[id]; if(c && c.messages.length>0){ emptyState.style.display='none'; messagesContainer.style.display='block'; c.messages.forEach(m=>addMessage(m.role,m.content,false)); } else { emptyState.style.display='flex'; messagesContainer.style.display='none'; } renderChatHistory(); }
function deleteChat(id,e){ e.stopPropagation(); if(confirm('Are you sure you want to delete this chat?')){ delete chats[id]; saveChats(); if(currentChatId===id) createNewChat(); else renderChatHistory(); } }
function renderChatHistory(){ const hc=document.getElementById('chatHistory'); const arr=Object.values(chats).sort((a,b)=>b.updatedAt-a.updatedAt); if(arr.length===0){ hc.innerHTML='<div class="empty-chat-history">No chats yet</div>'; return; } hc.innerHTML=''; arr.forEach(chat=>{ const item=document.createElement('div'); item.className='chat-item'+(chat.id===currentChatId?' active':''); item.onclick=()=>loadChat(chat.id); const text=document.createElement('span'); text.className='chat-item-text'; text.textContent=getChatTitle(chat.messages); const del=document.createElement('button'); del.className='chat-item-delete'; del.innerHTML=`<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2"/></svg>`; del.onclick=e=>deleteChat(chat.id,e); item.appendChild(text); item.appendChild(del); hc.appendChild(item); }); }
function clearMessages(){ messagesContainer.innerHTML=''; messagesContainer.style.display='none'; emptyState.style.display='flex'; }

userInput.addEventListener('input',()=>{ sendBtn.disabled=userInput.value.trim()===''; });
function autoResize(t){ t.style.height='auto'; t.style.height=Math.min(t.scrollHeight,200)+'px'; }
function handleKeyDown(e){ if(e.key==='Enter'&&!e.shiftKey){ e.preventDefault(); if(userInput.value.trim()) sendMessage(); } }

// ---- SEND MESSAGE WITH REAL AI & MARKDOWN ----
async function sendMessage(){
    const msg=userInput.value.trim();
    if(!msg) return;
    if(!currentChatId) createNewChat();
    emptyState.style.display='none'; messagesContainer.style.display='block';
    addMessage('user',msg);
    userInput.value=''; userInput.style.height='auto'; sendBtn.disabled=true;

    try{
        const res=await fetch('https://closed-ai-api.onrender.com/generate',{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({prompt:msg,model:currentModelName})
        });
        const data=await res.json();
        if(data.response) addMessage('assistant',data.response);
        else if(data.error) addMessage('assistant',`Error: ${data.error}`);
        else addMessage('assistant',"I didn't get a response. Try again.");
    }catch(err){ console.error(err); addMessage('assistant',"Network error. Unable to reach AI."); }
}

function addMessage(role, content, saveToChat = true) {
    const div = document.createElement('div');
    div.className = 'message';

    const avatar = document.createElement('div');
    avatar.className = `message-avatar ${role === 'user' ? 'user-avatar-msg' : 'assistant-avatar'}`;
    if (role === 'user') {
        avatar.innerHTML = profileData.picture
            ? `<img src="${profileData.picture}" alt="Profile">`
            : profileData.name.charAt(0).toUpperCase();
    } else {
        avatar.innerHTML = `<img src="images/favicon.ico" alt="AI" style="width:20px;height:20px;">`;
    }

    const contentDiv = document.createElement('div');
    contentDiv.className = 'message-content';

    // Render Markdown using marked
    const p = document.createElement('p');
    p.innerHTML = marked.parse(content, {
        gfm: true,
        breaks: true,
        highlight: function(code, lang) {
            if (lang && hljs.getLanguage(lang)) {
                return hljs.highlight(code, { language: lang }).value;
            }
            return hljs.highlightAuto(code).value;
        }
    });
    contentDiv.appendChild(p);

    div.appendChild(avatar);
    div.appendChild(contentDiv);
    messagesContainer.appendChild(div);

    // Highlight all code blocks
    div.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));

    // Scroll to bottom
    chatContainer.scrollTop = chatContainer.scrollHeight;

    // Save message to chat
    if (saveToChat && currentChatId) {
        if (!chats[currentChatId].messages) chats[currentChatId].messages = [];
        chats[currentChatId].messages.push({
            role: role,
            content: content,
            timestamp: Date.now()
        });
        chats[currentChatId].updatedAt = Date.now();
        saveChats();
        renderChatHistory();
    }
}

function sendSuggestion(el){
    const t=el.querySelector('.suggestion-title').textContent;
    const txt=el.querySelector('.suggestion-text').textContent;
    userInput.value=`${t} ${txt}`; sendBtn.disabled=false; userInput.focus();
}

// ---- INIT ----
loadProfile(); loadModel(); loadChats(); if(Object.keys(chats).length===0) createNewChat();
</script>
</body>
</html>
